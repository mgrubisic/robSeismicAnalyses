function [uninsuredLoss, insuredLoss] = insurancePayout(...
    groundUpLoss, deductible, cover, coinsurance, varargin)
%insurancePayout calculates the insurance payout given a vector of losses
%   
%   INPUT
%   
%   groundUpLoss can have as many columns as preferred
%   deductible, cover and coinsurance are scalars. They should be
%   consisitent with the definition of the losses (i.e. if losses are
%   normalised, they should be normalised too)

%% Example

% vulnDollar = [0;1.58193632911131e-39;1.97463148555150e-28;8.44080942896286e-23;4.53927553253909e-19;2.85625089380607e-16;4.22713051419902e-14;2.18054980897997e-12;5.20930367020198e-11;7.02404791315433e-10;6.12984229179334e-09;3.81338457440717e-08;1.81347621308944e-07;6.94300164586260e-07;2.22573569004817e-06;6.15868055071745e-06;1.50655604575267e-05;3.32115390398944e-05;6.70130864785302e-05;0.000125361025770079;0.000219752781329269;0.000364233348554297;0.000575198097545503;0.000871145265364547;0.00127247309439253;0.00180139720843554;0.00248202644278083;0.00334059150425397;0.00440578132174556;0.00570911434314127;0.00728525985381303;0.00917222743237523;0.0114113580553051;0.0140470738367156;0.0171263703718830;0.0206980620859524;0.0248118137931066;0.0295170089076555;0.0348615155630427;0.0408904163304549;0.0476447659789960;0.0551604358783419;0.0634670944872183;0.0725873621792251;0.0825361665993351;0.0933203127990035;0.104938271321248;0.117380177728000;0.130628029098579;0.144656056917401;0.159431251502383;0.174914010585905;0.191058883655974;0.207815383961247;0.225128841425500;0.242941271851440;0.261192240481781;0.279819701012830;0.298760794338060;0.317952594484103;0.337332792269174;0.356840310074668;0.376415843712107;0.396002329651677;0.415545337836633;0.434993391937773;0.454298220214176;0.473414941159801;0.492302188856228;0.510922183449194;0.529240752452255;0.547227308686494;0.564854790621617;0.582099570719960;0.598941337127587;0.615362953729611;0.631350303211177;0.646892117359186;0.661979798418032;0.676607234887965;0.690770614737060;0.704468238595234;0.717700335116945;0.730468880342530;0.742777422559141;0.754630913862614;0.766035549351819;0.776998614646851;0.787528342211078;0.797633776773138;0.807324649986975;0.816611264333906;0.825504386158756;0.834015147639997;0.842154957419775;0.849935419561559;0.857368260459056;0.864465263288235;0.871238209572996;0.877698827422829;0.883858745996155;0.889729455744745;0.895322274001533;0.900648315485214;0.905718467309395;0.910543368100949;0.915133390850980;0.919498629141802;0.923648886414123;0.927593667959817;0.931342175346851;0.934903303003941;0.938285636712998;0.941497453777329;0.944546724652691;0.947441115846520;0.950187993908025;0.952794430348183;0.955267207343992;0.957612824095772;0.959837503719581;0.961947200569274;0.963947607894135;0.965844165748575;0.967642069080032;0.969346275930074;0.970961515691743;0.972492297373532;0.973942917826998;0.975317469901031;0.976619850491215;0.977853768457557;0.979022752388207;0.980130158190709;0.981179176495747;0.982172839861430;0.983114029768885;0.984005483402296;0.984849800208639;0.985649448234187;0.986406770236448;0.987123989571592;0.987803215858578;0.988446450422231;0.989055591518354;0.989632439344685;0.990178700842109;0.990695994291009;0.991185853708034;0.991649733048879;0.992089010222891;0.992504990925476;0.992898912294414;0.993271946396234;0.993625203548810;0.993959735486350;0.994276538372879;0.994576555670244;0.994860680866581;0.995129760071061;0.995384594480612;0.995625942724152;0.995854523089747;0.996071015639909;0.996276064220133;0.996470278365553;0.996654235110472;0.996828480705320;0.996993532245439;0.997149879215911;0.997297984956502;0.997438288050590;0.997571203641830;0.997697124682112;0.997816423114230;0.997929450992537;0.998036541544689;0.998138010177477;0.998234155429567;0.998325259873869;0.998411590972125;0.998493401884146;0.998570932234073;0.998644408835870;0.998714046380165;0.998780048084471;0.998842606308689;0.998901903137715;0.998958110932880;0.999011392853871;0.999061903352683;0.999109788641081;0.999155187132984;0.999198229863100;0.999239040883063;0.999277737636286;0.999314431312660;0.999349227184165;0.999382224922433;0.999413518899207;0.999443198470635;0.999471348246242;0.999498048343426;0.999523374628238;0.999547398943191;0.999570189322801;0.999591810197505;0.999612322586598;0.999631784280777;0.999650250014841;0.999667771631099;0.999684398233965;0.999700176336231;0.999715149997471;0.999729360954972;0.999742848747646;0.999755650833243;0.999767802699283;0.999779337968002;0.999790288495668;0.999800684466547;0.999810554481826;0.999819925643759;0.999828823635289;0.999837272795399;0.999845296190417;0.999852915681503;0.999860151988505;0.999867024750407;0.999873552582526;0.999879753130654;0.999885643122302;0.999891238415197;0.999896554043195;0.999901604259729;0.999906402578949;0.999910961814656;0.999915294117164;0.999919411008193;0.999923323413907;0.999927041696188;0.999930575682247;0.999933934692660;0.999937127567915;0.999940162693546;0.999943048023931;0.999945791104834;0.999948399094746;0.999950878785093;0.999953236619382;0.999955478711328;0.999957610862022;0.999959638576194;0.999961567077618;0.999963401323701;0.999965146019302;0.999966805629831;0.999968384393647;0.999969886333811;0.999971315269219;0.999972674825149;0.999973968443258;0.999975199391050;0.999976370770849;0.999977485528305;0.999978546460451;0.999979556223343;0.999980517339294;0.999981432203739;0.999982303091732;0.999983132164118;0.999983921473364;0.999984672969111;0.999985388503414;0.999986069835723;0.999986718637606;0.999987336497220;0.999987924923553;0.999988485350453;0.999989019140435;0.999989527588308;0.999990011924598;0.999990473318806;0.999990912882497;0.999991331672221;0.999991730692295;0.999992110897437;0.999992473195261;0.999992818448652;0.999993147478011;0.999993461063394;0.999993759946531;0.999994044832751;0.999994316392805;0.999994575264592;0.999994822054806;0.999995057340493;0.999995281670526;0.999995495567013;0.999995699526629;0.999995894021878;0.999996079502298;0.999996256395594;0.999996425108730;0.999996586028948;0.999996739524746;0.999996885946808;0.999997025628877;0.999997158888599;0.999997286028307;0.999997407335782;0.999997523084965;0.999997633536637;0.999997738939066;0.999997839528619;0.999997935530346;0.999998027158534;0.999998114617229;0.999998198100741;0.999998277794117;0.999998353873591;0.999998426507013;0.999998495854258;0.999998562067612;0.999998625292141;0.999998685666041;0.999998743320968;0.999998798382357;0.999998850969723;0.999998901196943;0.999998949172532;0.999998994999898;0.999999038777589;0.999999080599528;0.999999120555230;0.999999158730020;0.999999195205228;0.999999230058383;0.999999263363396;0.999999295190727;0.999999325607558;0.999999354677940;0.999999382462950;0.999999409020828;0.999999434407111;0.999999458674764;0.999999481874302;0.999999504053904;0.999999525259521;0.999999545534990;0.999999564922122;0.999999583460809;0.999999601189106;0.999999618143320;0.999999634358094;0.999999649866482;0.999999664700026;0.999999678888826;0.999999692461606;0.999999705445781;0.999999717867515;0.999999729751783;0.999999741122422;0.999999752002188;0.999999762412804;0.999999772375009;0.999999781908601;0.999999791032486;0.999999799764712;0.999999808122517;0.999999816122358;0.999999823779954;0.999999831110315;0.999999838127779;0.999999844846037;0.999999851278170;0.999999857436671;0.999999863333475;0.999999868979984;0.999999874387090;0.999999879565201;0.999999884524260;0.999999889273769;0.999999893822806;0.999999898180048;0.999999902353787;0.999999906351947;0.999999910182101;0.999999913851488;0.999999917367029;0.999999920735336;0.999999923962734;0.999999927055266;0.999999930018713;0.999999932858599;0.999999935580207;0.999999938188589;0.999999940688575;0.999999943084786;0.999999945381638;0.999999947583356;0.999999949693982;0.999999951717380;0.999999953657247;0.999999955517120;0.999999957300382;0.999999959010269;0.999999960649877;0.999999962222169;0.999999963729979;0.999999965176020;0.999999966562886;0.999999967893061;0.999999969168922;0.999999970392743;0.999999971566702;0.999999972692881;0.999999973773276;0.999999974809795;0.999999975804267;0.999999976758439;0.999999977673988;0.999999978552517;0.999999979395561;0.999999980204590;0.999999980981012;0.999999981726175;0.999999982441370;0.999999983127832;0.999999983786747;0.999999984419247;0.999999985026419;0.999999985609303;0.999999986168896;0.999999986706152;0.999999987221986;0.999999987717274;0.999999988192855;0.999999988649534;0.999999989088082;0.999999989509236;0.999999989913704;0.999999990302165;0.999999990675268;0.999999991033636;0.999999991377866;0.999999991708531;0.999999992026178;0.999999992331332;0.999999992624500;0.999999992906162;0.999999993176782;0.999999993436805;0.999999993686656;0.999999993926743;0.999999994157458;0.999999994379175;0.999999994592256;0.999999994797044;0.999999994993872;0.999999995183056;0.999999995364900;0.999999995539698;0.999999995707729;0.999999995869262;0.999999996024554;0.999999996173854;0.999999996317397;0.999999996455413;0.999999996588118;0.999999996715724;0.999999996838430;0.999999996956430;0.999999997069909;0.999999997179044;0.999999997284007;0.999999997384961;0.999999997482063;0.999999997575463;0.999999997665307;0.999999997751733;0.999999997834875;0.999999997914861;0.999999997991813;0.999999998065850;0.999999998137085;0.999999998205627;0.999999998271580;0.999999998335045;0.999999998396117;0.999999998454890;0.999999998511452;0.999999998565888;0.999999998618281;0.999999998668709;0.999999998717248;0.999999998763970;0.999999998808945;0.999999998852240;0.999999998893920;0.999999998934046];
% [uninsuredLoss, insuredLoss] = insurancePayout(...
%     vulnDollar(:,1), 0.1, 0.7, 0.9, 'plot');

%% Optional input

% max number of inputs
numvarargs = length(varargin);
if numvarargs > 1
    error('myfuns:somefun2Alt:TooManyInputs', ...
        'requires at most 1 optional inputs');
end

% set defaults for optional inputs
optargs = { 'NOplot' };

% now put these defaults into the valuesToUse cell array, 
% and overwrite with the ones specified in varargin.
optargs(1:numvarargs) = varargin;
% or ...
% [optargs{1:numvarargs}] = varargin{:};

% Place optional args in memorable variable names
[ plotter ] = optargs{:};

%% Payout

insuredLoss = zeros(size(groundUpLoss));

insuredLoss(groundUpLoss>deductible & groundUpLoss<cover) = coinsurance * ...
    (groundUpLoss((groundUpLoss>deductible & groundUpLoss<cover)) - deductible);
insuredLoss(groundUpLoss>=cover) = coinsurance * max(cover - deductible,0);
% the max fx is needed to handle the impossible cases of cover<deductible

uninsuredLoss = groundUpLoss - insuredLoss;

%% Plot

if strcmp(plotter, 'plot')
    f = figure; hold on
    plot(groundUpLoss, 'k')
    plot(insuredLoss, 'b')
    plot(uninsuredLoss, 'r')
    plot(f.Children.XLim, deductible * [1 1], '--k')
    plot(f.Children.XLim, cover * [1 1], '--k')
    
    ylabel('Loss')
    legend('Ground up', sprintf('Insured (coI=%2.2f)', coinsurance), 'Uninsured')
    set(gca, 'FontSize', 18)
end

end
